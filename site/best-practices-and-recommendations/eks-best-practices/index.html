
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>EKS Best Practices - EMR Containers Best Practices Guides</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="None" data-md-color-accent="None">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#eks-best-practices-and-recommendations" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="EMR Containers Best Practices Guides" class="md-header__button md-logo" aria-label="EMR Containers Best Practices Guides" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EMR Containers Best Practices Guides
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              EKS Best Practices
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aws/aws-emr-containers-best-practices" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-emr-containers-best-practices
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        Guides
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../security/docs/spark/encryption/" class="md-tabs__link">
        Security
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../submit-applications/docs/spark/pyspark/" class="md-tabs__link">
        Submit applications
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../storage/docs/spark/ebs/" class="md-tabs__link">
        Storage
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../metastore-integrations/docs/hive-metastore/" class="md-tabs__link">
        Metastore Integration
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../debugging/docs/change-log-level/" class="md-tabs__link">
        Debugging
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../troubleshoot/docs/troubleshooting/" class="md-tabs__link">
        Troubleshooting
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../node-placement/docs/eks-node-placement/" class="md-tabs__link">
        Node Placement
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../performance/docs/dra/" class="md-tabs__link md-tabs__link--active">
        Performance
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../cost-optimization/docs/cost-optimization/" class="md-tabs__link">
        Cost Optimization
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="EMR Containers Best Practices Guides" class="md-nav__button md-logo" aria-label="EMR Containers Best Practices Guides" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    EMR Containers Best Practices Guides
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aws/aws-emr-containers-best-practices" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-emr-containers-best-practices
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Guides
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Guides" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Guides
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../outposts/emr-containers-on-outposts/" class="md-nav__link">
        EMR on EKS(AWS Outposts)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Security
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Security" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Security
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/spark/encryption/" class="md-nav__link">
        Encryption
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/spark/data-encryption/" class="md-nav__link">
        Data Encryption
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/spark/network-security/" class="md-nav__link">
        Network Security
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/spark/secrets/" class="md-nav__link">
        Secrets
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Submit applications
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Submit applications" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Submit applications
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../submit-applications/docs/spark/pyspark/" class="md-nav__link">
        Pyspark
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Storage
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Storage" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Storage
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../storage/docs/spark/ebs/" class="md-nav__link">
        EBS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../storage/docs/spark/fsx-lustre/" class="md-nav__link">
        FSx for Lustre
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../storage/docs/spark/instance-store/" class="md-nav__link">
        Instance Store
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Metastore Integration
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Metastore Integration" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Metastore Integration
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../metastore-integrations/docs/hive-metastore/" class="md-nav__link">
        Hive Metastore
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../metastore-integrations/docs/aws-glue/" class="md-nav__link">
        AWS Glue
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Debugging
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Debugging" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Debugging
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../debugging/docs/change-log-level/" class="md-nav__link">
        Change Log Level
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../debugging/docs/connect-spark-ui/" class="md-nav__link">
        Connect to Spark UI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../debugging/docs/self-hosted-shs/" class="md-nav__link">
        Self Hosted SHS
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Troubleshooting
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Troubleshooting" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Troubleshooting
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshoot/docs/troubleshooting/" class="md-nav__link">
        Troubleshooting EMR on EKS Issues
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          Node Placement
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Node Placement" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Node Placement
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../node-placement/docs/eks-node-placement/" class="md-nav__link">
        EKS Node placement
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../node-placement/docs/fargate-node-placement/" class="md-nav__link">
        EKS Fargate Node placement
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_9">
          Performance
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Performance" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Performance
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../performance/docs/dra/" class="md-nav__link">
        Dynamic Resource Allocation
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          EKS Best Practices
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        EKS Best Practices
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#amazon-vpc-cni-best-practices" class="md-nav__link">
    Amazon VPC CNI Best practices
  </a>
  
    <nav class="md-nav" aria-label="Amazon VPC CNI Best practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#recommendation-1-improve-ip-address-utilization" class="md-nav__link">
    Recommendation 1: Improve IP Address Utilization
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recommendation-2-prevent-ec2-vpc-api-throttling-from-assignprivateipaddresses-attachnetworkinterface" class="md-nav__link">
    Recommendation 2: Prevent EC2 VPC API throttling from AssignPrivateIpAddresses &amp; AttachNetworkInterface
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#other-recommendations-for-amazon-vpc-cni" class="md-nav__link">
    Other Recommendations for Amazon VPC CNI
  </a>
  
    <nav class="md-nav" aria-label="Other Recommendations for Amazon VPC CNI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plan-for-growth" class="md-nav__link">
    Plan for growth
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor-ip-address-inventory" class="md-nav__link">
    Monitor IP address inventory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snat-setting" class="md-nav__link">
    SNAT setting
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coredns-best-practices" class="md-nav__link">
    CoreDNS Best practices
  </a>
  
    <nav class="md-nav" aria-label="CoreDNS Best practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prevent-coredns-from-being-overwhelmed-unknownhostexception-in-spark-jobs-and-other-pods" class="md-nav__link">
    Prevent CoreDNS from being overwhelmed (UnknownHostException in spark jobs and other pods)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor-coredns-metrics" class="md-nav__link">
    Monitor CoreDNS metrics
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster-autoscaler-best-practices" class="md-nav__link">
    Cluster Autoscaler Best practices
  </a>
  
    <nav class="md-nav" aria-label="Cluster Autoscaler Best practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#increase-cluster-autoscaler-memory-to-avoid-unnecessary-exceptions" class="md-nav__link">
    Increase cluster-autoscaler memory to avoid unnecessary exceptions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#avoid-job-failures-when-cluster-autoscaler-attempts-scale-in" class="md-nav__link">
    Avoid job failures when Cluster Autoscaler attempts scale-in
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-overprovisioning-with-cluster-autoscaler-for-higher-priority-jobs" class="md-nav__link">
    Configure overprovisioning with Cluster Autoscaler for higher priority jobs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#eks-control-plane-best-practices" class="md-nav__link">
    EKS Control Plane Best practices
  </a>
  
    <nav class="md-nav" aria-label="EKS Control Plane Best practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#api-server-overwhelmed" class="md-nav__link">
    API server overwhelmed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor-control-plane-metrics" class="md-nav__link">
    Monitor Control Plane Metrics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-server" class="md-nav__link">
    API Server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#etcd" class="md-nav__link">
    etcd
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_10" type="checkbox" id="__nav_10" >
      
      
      
      
        <label class="md-nav__link" for="__nav_10">
          Cost Optimization
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Cost Optimization" data-md-level="1">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          Cost Optimization
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cost-optimization/docs/cost-optimization/" class="md-nav__link">
        Cost Optimization using EC2 Spot Instances
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cost-optimization/docs/node-decommission/" class="md-nav__link">
        Node Decommission
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#amazon-vpc-cni-best-practices" class="md-nav__link">
    Amazon VPC CNI Best practices
  </a>
  
    <nav class="md-nav" aria-label="Amazon VPC CNI Best practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#recommendation-1-improve-ip-address-utilization" class="md-nav__link">
    Recommendation 1: Improve IP Address Utilization
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recommendation-2-prevent-ec2-vpc-api-throttling-from-assignprivateipaddresses-attachnetworkinterface" class="md-nav__link">
    Recommendation 2: Prevent EC2 VPC API throttling from AssignPrivateIpAddresses &amp; AttachNetworkInterface
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#other-recommendations-for-amazon-vpc-cni" class="md-nav__link">
    Other Recommendations for Amazon VPC CNI
  </a>
  
    <nav class="md-nav" aria-label="Other Recommendations for Amazon VPC CNI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plan-for-growth" class="md-nav__link">
    Plan for growth
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor-ip-address-inventory" class="md-nav__link">
    Monitor IP address inventory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snat-setting" class="md-nav__link">
    SNAT setting
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coredns-best-practices" class="md-nav__link">
    CoreDNS Best practices
  </a>
  
    <nav class="md-nav" aria-label="CoreDNS Best practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prevent-coredns-from-being-overwhelmed-unknownhostexception-in-spark-jobs-and-other-pods" class="md-nav__link">
    Prevent CoreDNS from being overwhelmed (UnknownHostException in spark jobs and other pods)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor-coredns-metrics" class="md-nav__link">
    Monitor CoreDNS metrics
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cluster-autoscaler-best-practices" class="md-nav__link">
    Cluster Autoscaler Best practices
  </a>
  
    <nav class="md-nav" aria-label="Cluster Autoscaler Best practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#increase-cluster-autoscaler-memory-to-avoid-unnecessary-exceptions" class="md-nav__link">
    Increase cluster-autoscaler memory to avoid unnecessary exceptions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#avoid-job-failures-when-cluster-autoscaler-attempts-scale-in" class="md-nav__link">
    Avoid job failures when Cluster Autoscaler attempts scale-in
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-overprovisioning-with-cluster-autoscaler-for-higher-priority-jobs" class="md-nav__link">
    Configure overprovisioning with Cluster Autoscaler for higher priority jobs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#eks-control-plane-best-practices" class="md-nav__link">
    EKS Control Plane Best practices
  </a>
  
    <nav class="md-nav" aria-label="EKS Control Plane Best practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#api-server-overwhelmed" class="md-nav__link">
    API server overwhelmed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor-control-plane-metrics" class="md-nav__link">
    Monitor Control Plane Metrics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-server" class="md-nav__link">
    API Server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#etcd" class="md-nav__link">
    etcd
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/aws/aws-emr-containers-best-practices/edit/master/docs/best-practices-and-recommendations/eks-best-practices.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="eks-best-practices-and-recommendations"><strong>EKS Best Practices and Recommendations</strong><a class="headerlink" href="#eks-best-practices-and-recommendations" title="Permanent link">&para;</a></h1>
<p>Amazon EMR on EKS team has run scale tests on EKS cluster and has compiled a list of recommendations. The purpose of this document is to share our recommendations for running large scale EKS clusters supporting EMR on EKS.</p>
<h3 id="amazon-vpc-cni-best-practices"><strong>Amazon VPC CNI Best practices</strong><a class="headerlink" href="#amazon-vpc-cni-best-practices" title="Permanent link">&para;</a></h3>
<h4 id="recommendation-1-improve-ip-address-utilization"><strong>Recommendation 1: Improve IP Address Utilization</strong><a class="headerlink" href="#recommendation-1-improve-ip-address-utilization" title="Permanent link">&para;</a></h4>
<p>EKS clusters can run out of IP addresses for pods when they reached between 400 and 500 nodes. With the default CNI settings, each node can request more IP addresses than is required. To ensure that you don’t run out of IP addresses, there are two solutions:</p>
<ol>
<li>
<p>Set <strong>MINIMUM_IP_TARGET</strong> and <strong>WARM_IP_TARGET</strong> instead of the default setting of <strong>WARM_ENI_TARGET=1</strong>. The values of these settings will depend on your instance type, expected pod density, and workload. More info about these CNI settings can be found <a href="https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/eni-and-ip-target.md">here</a>. The maximum number of IP addresses per node (and thus maximum number of pods per node) depends on instance type and can be looked up <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html#AvailableIpPerENI">here</a>.</p>
</li>
<li>
<p>If you have found the right CNI settings as described above, the subnets created by eksctl still do not provide enough addresses (by default eksctl creates a “/19” subnet for each nodegroup, which contains ~8.1k addresses). You can configure CNI to take addresses from (larger) subnets that you create. For example, you could create a few “/16” subnets, which contain ~65k IP addresses per subnet. You should implement this option after you have configured the CNI settings as described in #1. To configure your pods to use IP addresses from larger manually-created subnets, use CNI custom networking (see below for more information):</p>
</li>
</ol>
<p><strong>CNI custom networking</strong></p>
<p>By default, the CNI assigns the Pod’s IP address from the worker node's primary elastic network interface's (ENI) security groups and subnet. If you don’t have enough IP addresses in the worker node subnet, or prefer that the worker nodes and Pods reside in separate subnets to avoid IP address allocation conflicts between Pods and other resources in the VPC, you can use <a href="https://docs.aws.amazon.com/eks/latest/userguide/cni-custom-network.html">CNI custom networking</a>.</p>
<p>Enabling a custom network removes an available elastic network interface (and all of its available IP addresses for pods) from each worker node that uses it. The worker node's primary network interface is not used for pod placement when a custom network is enabled.</p>
<p>If you want the CNI to assign IP addresses for Pods from a different subnet, you can set <code>AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG</code> environment variable to <code>true</code>.</p>
<div class="codehilite"><pre><span></span><code>kubectl <span class="nb">set</span> env daemonset aws-node <span class="se">\</span>
-n kube-system <span class="nv">AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG</span><span class="o">=</span><span class="nb">true</span>
</code></pre></div>

<p>When <code>AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG=true</code>, the CNI will assign Pod IP address from a subnet defined in <code>ENIConfig</code>. The <code>ENIConfig</code> custom resource is used to define the subnet in which Pods will be scheduled. </p>
<div class="codehilite"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">crd.k8s.amazonaws.com/v1alpha1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ENIConfig</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"> </span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">us-west-2a</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"> </span>
<span class="w">  </span><span class="nt">securityGroups</span><span class="p">:</span><span class="w"> </span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sg-0dff111a1d11c1c11</span><span class="w"></span>
<span class="w">  </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">subnet-011b111c1f11fdf11</span><span class="w"></span>
</code></pre></div>

<p>You will need to create an <code>ENIconfig</code> custom resource for each subnet you want to use for Pod networking. </p>
<ul>
<li>
<p>The <code>securityGroups</code> field should have the ID of the security group attached to the worker nodes. </p>
</li>
<li>
<p>The <code>name</code> field should be the name of the Availability Zone in your VPC. If you name your ENIConfig custom resources after each Availability Zone in your VPC, you can enable Kubernetes to automatically apply the corresponding ENIConfig for the worker node Availability Zone with the following command.</p>
</li>
</ul>
<div class="codehilite"><pre><span></span><code>kubectl <span class="nb">set</span> env daemonset aws-node <span class="se">\</span>
-n kube-system <span class="nv">ENI_CONFIG_LABEL_DEF</span><span class="o">=</span>failure-domain.beta.kubernetes.io/zone
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Upon creating the <code>ENIconfig</code> custom resources, you will need to create new worker nodes. The existing worker nodes and Pods will remain unaffected.</p>
</div>
<h4 id="recommendation-2-prevent-ec2-vpc-api-throttling-from-assignprivateipaddresses-attachnetworkinterface"><strong>Recommendation 2: Prevent EC2 VPC API throttling from AssignPrivateIpAddresses &amp; AttachNetworkInterface</strong><a class="headerlink" href="#recommendation-2-prevent-ec2-vpc-api-throttling-from-assignprivateipaddresses-attachnetworkinterface" title="Permanent link">&para;</a></h4>
<p>Often EKS cluster scale-out time can increase because the CNI is being throttled by the EC2 VPC APIs. The following steps can be taken to prevent these issues:</p>
<ol>
<li>
<p>Use CNI version 1.8.0 or later as it reduces the calls to EC2 VPC APIs than earlier versions.</p>
</li>
<li>
<p>Configure the <strong>MINIMUM_IP_TARGET</strong> and <strong>WARM_IP_TARGET</strong> parameters instead of the default parameter of <strong>WARM_ENI_TARGET=1</strong>. Only those IP addresses that are necessary are requested from EC2. The values of these settings will depend on your instance type and expected pod density. More info about these settings <a href="https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/eni-and-ip-target.md">here</a>.</p>
</li>
<li>
<p>Request an API limit increase on the EC2 VPC APIs that are getting throttled. This option should be considered only after steps 1 &amp; 2 have been done.</p>
</li>
</ol>
<h3 id="other-recommendations-for-amazon-vpc-cni"><strong>Other Recommendations for Amazon VPC CNI</strong><a class="headerlink" href="#other-recommendations-for-amazon-vpc-cni" title="Permanent link">&para;</a></h3>
<h4 id="plan-for-growth"><strong>Plan for growth</strong><a class="headerlink" href="#plan-for-growth" title="Permanent link">&para;</a></h4>
<p>Size the subnets you will use for Pod networking for growth. If you have insufficient IP addresses available in the subnet that the CNI uses, your pods will not get an IP address. The pods will remain in the pending state until an IP address becomes available. This may impact application autoscaling and compromise its availability.</p>
<h4 id="monitor-ip-address-inventory"><strong>Monitor IP address inventory</strong><a class="headerlink" href="#monitor-ip-address-inventory" title="Permanent link">&para;</a></h4>
<p>You can monitor the IP addresses inventory of subnets using the <a href="https://docs.aws.amazon.com/eks/latest/userguide/cni-metrics-helper.html">CNI Metrics Helper</a>, and set <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html">CloudWatch alarms</a> to get notified if a subnet is running out of IP addresses.</p>
<h4 id="snat-setting"><strong>SNAT setting</strong><a class="headerlink" href="#snat-setting" title="Permanent link">&para;</a></h4>
<p>Source Network Address Translation (source-nat or SNAT) allows traffic from a private network to go out to the internet. Virtual machines launched on a private network can get to the internet by going through a gateway capable of performing SNAT. If your Pods with private IP address need to communicate with other private IP address spaces (for example, Direct Connect, VPC Peering or Transit VPC), then you should enable <a href="https://docs.aws.amazon.com/eks/latest/userguide/external-snat.html">external SNAT</a> in the CNI:</p>
<div class="codehilite"><pre><span></span><code>kubectl <span class="nb">set</span> env daemonset <span class="se">\</span>
-n kube-system aws-node <span class="nv">AWS_VPC_K8S_CNI_EXTERNALSNAT</span><span class="o">=</span><span class="nb">true</span>
</code></pre></div>

<h3 id="coredns-best-practices"><strong>CoreDNS Best practices</strong><a class="headerlink" href="#coredns-best-practices" title="Permanent link">&para;</a></h3>
<h4 id="prevent-coredns-from-being-overwhelmed-unknownhostexception-in-spark-jobs-and-other-pods"><strong>Prevent CoreDNS from being overwhelmed (UnknownHostException in spark jobs and other pods)</strong><a class="headerlink" href="#prevent-coredns-from-being-overwhelmed-unknownhostexception-in-spark-jobs-and-other-pods" title="Permanent link">&para;</a></h4>
<p>CoreDNS is a deployment, which means it runs a fixed number of replicas and thus does not scale out with the cluster. This can be a problem for workloads that do a lot of DNS lookups. One simple solution is to install <a href="https://kubernetes.io/docs/tasks/administer-cluster/dns-horizontal-autoscaling/#enablng-dns-horizontal-autoscaling">dns-autoscaler</a>, which adjusts the number of replicas of the CoreDNS deployment as the cluster grows and shrinks.</p>
<h4 id="monitor-coredns-metrics"><strong>Monitor CoreDNS metrics</strong><a class="headerlink" href="#monitor-coredns-metrics" title="Permanent link">&para;</a></h4>
<p>CoreDNS is a deployment, which means it runs a fixed number of replicas and thus does not scale out with the cluster. This can cause workloads to timeout with unknownHostException as spark-executors will do a lot of DNS lookups which registering themselves to spark-driver. One simple solution to fix this is to install <a href="https://kubernetes.io/docs/tasks/administer-cluster/dns-horizontal-autoscaling/#enablng-dns-horizontal-autoscaling">dns-autoscaler</a>, which adjusts the number of replicas of the CoreDNS deployment as the cluster grows and shrinks.</p>
<h2 id="cluster-autoscaler-best-practices"><strong>Cluster Autoscaler Best practices</strong><a class="headerlink" href="#cluster-autoscaler-best-practices" title="Permanent link">&para;</a></h2>
<h4 id="increase-cluster-autoscaler-memory-to-avoid-unnecessary-exceptions"><strong>Increase cluster-autoscaler memory to avoid unnecessary exceptions</strong><a class="headerlink" href="#increase-cluster-autoscaler-memory-to-avoid-unnecessary-exceptions" title="Permanent link">&para;</a></h4>
<p>Cluster-autoscaler can require a lot of memory to run because it stores a lot of information about the state of the cluster, such as data about every pod and every node. If the cluster-autoscaler has insufficient memory, it can lead to the cluster-autoscaler crashing.  Ensure that you provide the cluster-autoscaler deployment more memory, e.g., 1Gi memory instead of the default 300Mi. Useful information about configuring the cluster-autoscaler for improved scalability and performance can be found <a href="https://docs.aws.amazon.com/eks/latest/userguide/cluster-autoscaler.html#ca-deployment-considerations">here</a></p>
<h4 id="avoid-job-failures-when-cluster-autoscaler-attempts-scale-in"><strong>Avoid job failures when Cluster Autoscaler attempts scale-in</strong><a class="headerlink" href="#avoid-job-failures-when-cluster-autoscaler-attempts-scale-in" title="Permanent link">&para;</a></h4>
<p>Cluster Autoscaler will attempt scale-in action for any under utilized instance within your EKScluster. When scale-in action is performed, all pods from that instance is relocated to another node. This could cause disruption for critical workloads. For example, if driver pod is restarted, the entire job needs to restart. For this reason, we recommend using Kubernetes annotations on all critical pods (especially driver pods) and for cluster autoscaler deployment. Please see <a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#what-types-of-pods-can-prevent-ca-from-removing-a-node">here</a> for more info</p>
<div class="codehilite"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">cluster-autoscaler.kubernetes.io/safe-to-evict=false</span><span class="w"></span>
</code></pre></div>

<h4 id="configure-overprovisioning-with-cluster-autoscaler-for-higher-priority-jobs"><strong>Configure overprovisioning with Cluster Autoscaler for higher priority jobs</strong><a class="headerlink" href="#configure-overprovisioning-with-cluster-autoscaler-for-higher-priority-jobs" title="Permanent link">&para;</a></h4>
<p>If the required resources is not available in the cluster, pods go into pending state. Cluster Autoscaler uses this metric to scale out the cluster and this activity can be time consuming (several minutes) for higher priority jobs. In order to minimize time required for scaling, we recommend <a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#how-can-i-configure-overprovisioning-with-cluster-autoscaler">overprovisioning</a> resources. You can launch pause pods(dummy workloads which sleeps until it receives SIGINT or SIGTERM) with negative priority to reserve EC2 capacity. Once the higher priority jobs are scheduled, these pause pods are preempted to make room for high priority pods which in turn scales out additional capacity as a buffer. You need to be aware that this is a trade-off as it adds slightly higher cost while minimizing scheduling latency. You can read more about over provisioning best practice <a href="https://aws.github.io/aws-eks-best-practices/cluster-autoscaling/#overprovisioning">here</a>.</p>
<h2 id="eks-control-plane-best-practices">EKS Control Plane Best practices<a class="headerlink" href="#eks-control-plane-best-practices" title="Permanent link">&para;</a></h2>
<h4 id="api-server-overwhelmed"><strong>API server overwhelmed</strong><a class="headerlink" href="#api-server-overwhelmed" title="Permanent link">&para;</a></h4>
<p>System pods, workload pods, and external systems can make many calls to the Kubernetes API server. This can decrease performance and also increase EMR on EKS job failures. There are multiple ways to avoid API server availability issues including but not limited to:</p>
<ul>
<li>
<p>By default, the EKS API servers are automatically scaled to meet your workload demand. If you see increased latencies, please contact AWS via a support ticket and work with engineering team to resolve the issue.</p>
</li>
<li>
<p>Consider reducing the scan interval of <a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#how-does-scale-up-work">cluster-autoscaler from the 10 second</a> default value. Each time the cluster-autoscaler runs, it makes many calls to the API server. However, this will result in the cluster scaling-out less frequently and in larger steps (and same with scaling back in when load is reduced). More information can be found about the cluster-autoscaler <a href="https://docs.aws.amazon.com/eks/latest/userguide/cluster-autoscaler.html#ca-deployment-considerations">here</a>. This is not recommended if you need jobs to start ASAP.</p>
</li>
<li>
<p>If you are running your own deployment of fluentd, an increased load on the APIserver can be observed. Consider using fluent-bit instead which makes fewer calls to the API server. More info can be found <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Container-Insights-EKS-logs.html">here</a></p>
</li>
</ul>
<h4 id="monitor-control-plane-metrics"><strong>Monitor Control Plane Metrics</strong><a class="headerlink" href="#monitor-control-plane-metrics" title="Permanent link">&para;</a></h4>
<p>Monitoring Kubernetes API metrics can give you insights into control plane performance and identify issues. An unhealthy control plane can compromise the availability of the workloads running inside the cluster. For example, poorly written controllers can overload the API servers, affecting your application's availability.</p>
<p>Kubernetes exposes control plane metrics at the  <code>/metrics</code> endpoint. </p>
<p>You can view the metrics exposed using <code>kubectl</code>:</p>
<div class="codehilite"><pre><span></span><code>kubectl get --raw /metrics
</code></pre></div>

<p>These metrics are represented in a <a href="https://github.com/prometheus/docs/blob/master/content/docs/instrumenting/exposition_formats.md">Prometheus text format</a>. </p>
<p>You can use Prometheus to collect and store these metrics. In May 2020, CloudWatch added support for monitoring Prometheus metrics in CloudWatch Container Insights. So you can also use Amazon CloudWatch to monitor the EKS control plane. You can follow the <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/ContainerInsights-Prometheus-Setup-configure.html#ContainerInsights-Prometheus-Setup-new-exporters">Tutorial for Adding a New Prometheus Scrape Target: Prometheus KPI Server Metrics</a> to collect metrics and create CloudWatch dashboard to monitor your cluster’s control plane.</p>
<p>You can also find Kubernetes API server metrics <a href="https://github.com/kubernetes/apiserver/blob/master/pkg/endpoints/metrics/metrics.go">here</a>. For example, <code>apiserver_request_duration_seconds</code> can indicate how long API requests are taking to run. </p>
<p>Consider monitoring these control plane metrics:</p>
<h3 id="api-server">API Server<a class="headerlink" href="#api-server" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th align="left">Metric</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>apiserver_request_total</code></td>
<td align="left">Counter of apiserver requests broken out for each verb, dry run value, group, version, resource, scope, component, client, and HTTP response contentType and code.</td>
</tr>
<tr>
<td align="left"><code>apiserver_request_duration_seconds*</code></td>
<td align="left">Response latency distribution in seconds for each verb, dry run value, group, version, resource, subresource, scope, and component.</td>
</tr>
<tr>
<td align="left"><code>rest_client_request_duration_seconds</code></td>
<td align="left">Request latency in seconds. Broken down by verb and URL.</td>
</tr>
<tr>
<td align="left"><code>apiserver_admission_controller_admission_duration_seconds</code></td>
<td align="left">Admission controller latency histogram in seconds, identified by name and broken out for each operation and API resource and type (validate or admit).</td>
</tr>
<tr>
<td align="left"><code>rest_client_request_duration_seconds</code></td>
<td align="left">Request latency in seconds. Broken down by verb and URL.</td>
</tr>
<tr>
<td align="left"><code>rest_client_requests_total</code></td>
<td align="left">Number of HTTP requests, partitioned by status code, method, and host.</td>
</tr>
</tbody>
</table>
<h3 id="etcd">etcd<a class="headerlink" href="#etcd" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th align="left">Metric</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>etcd_request_duration_seconds</code></td>
<td align="left">Etcd request latency in seconds for each operation and object type.</td>
</tr>
</tbody>
</table>
<p>You can visualize and monitor these Kubernetes API server requests, latency and etcD metrics on Grafana via <a href="https://grafana.com/grafana/dashboards/12006">Grafana dashboard 12006</a>.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../../performance/docs/dra/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Dynamic Resource Allocation" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Dynamic Resource Allocation
            </div>
          </div>
        </a>
      
      
        
        <a href="../../cost-optimization/docs/cost-optimization/" class="md-footer__link md-footer__link--next" aria-label="Next: Cost Optimization using EC2 Spot Instances" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Cost Optimization using EC2 Spot Instances
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs"], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
    
    
  </body>
</html>